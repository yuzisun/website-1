
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="KServe Documentation" name="description"/>
<link href="https://kserve.io/website/0.13/modelserving/v1beta1/custom/custom_model/" rel="canonical"/>
<link href="../../../../images/favicon/favicon-32x32.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-8.0.5" name="generator"/>
<title>How to write a custom predictor - KServe Documentation Website</title>
<link href="../../../../assets/stylesheets/main.a617204b.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.9204c3b2.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../../assets/_mkdocstrings.css" rel="stylesheet"/>
<link href="../../../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#deploy-custom-python-serving-runtime-with-inferenceservice">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
<aside class="md-banner">
<div class="md-banner__inner md-grid md-typeset">
<h1>
<b>KServe v0.13 is Released</b>, <a href="/website/0.13/blog/articles/2024-05-15-KServe-0.13-release/">Read blog &gt;&gt;</a>
</h1>
</div>
</aside>
</div>
<div data-md-component="outdated" hidden="">
<aside class="md-banner md-banner--warning">
</aside>
</div>
<header class="md-header md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="KServe Documentation Website" class="md-header__button md-logo" data-md-component="logo" href="../../../.." title="KServe Documentation Website">
<img alt="logo" src="../../../../images/logo/kserve.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            KServe Documentation Website
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              How to write a custom predictor
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/kserve/kserve" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../get_started/">
        Getting started
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../admin/serverless/serverless/">
        Administration Guide
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../../control_plane/">
        User Guide
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../reference/api/">
        API Reference
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../developer/developer/">
        Developer Guide
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../blog/articles/2023-10-08-KServe-0.13-release.md">
        Blog
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../../community/adopters/">
        Community
      </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="KServe Documentation Website" class="md-nav__button md-logo" data-md-component="logo" href="../../../.." title="KServe Documentation Website">
<img alt="logo" src="../../../../images/logo/kserve.png"/>
</a>
    KServe Documentation Website
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/kserve/kserve" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
          Getting started
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Getting started" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Getting started
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../get_started/">
        KServe Quickstart
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../get_started/first_isvc/">
        First InferenceService
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../get_started/swagger_ui/">
        Interact with InferenceService Swagger UI
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3">
          Administration Guide
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Administration Guide" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Administration Guide
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" id="__nav_3_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1">
          Install KServe
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Install KServe" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_1">
<span class="md-nav__icon md-icon"></span>
          Install KServe
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_1" id="__nav_3_1_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1_1">
          Serverless
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Serverless" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_1_1">
<span class="md-nav__icon md-icon"></span>
          Serverless
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../admin/serverless/serverless/">
        Serverless installation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../admin/serverless/servicemesh/">
        Istio Service Mesh
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../admin/serverless/kourier_networking/">
        Kourier Networking Layer
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../admin/modelmesh/">
        ModelMesh installation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../admin/kubernetes_deployment/">
        Kubernetes deployment installation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../admin/migration/">
        Migrating from KFServing
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4">
          User Guide
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="User Guide" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1">
          Concepts
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Concepts" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_1" id="__nav_4_1_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1_1">
          Control Plane
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Control Plane" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_1_1">
<span class="md-nav__icon md-icon"></span>
          Control Plane
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../control_plane/">
        Model Serving Control Plane
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1_2" id="__nav_4_1_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1_2">
          Data Plane
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Data Plane" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_1_2">
<span class="md-nav__icon md-icon"></span>
          Data Plane
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data_plane/data_plane/">
        Model Serving Data Plane
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data_plane/v1_protocol/">
        V1 Inference Protocol
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../data_plane/v2_protocol/">
        Open Inference Protocol (V2 Inference Protocol)
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../servingruntimes/">
        Serving Runtimes
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2">
          Model Serving Runtimes
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Model Serving Runtimes" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
          Model Serving Runtimes
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1" id="__nav_4_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2_1">
          Supported Model Frameworks/Formats
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Supported Model Frameworks/Formats" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_2_1">
<span class="md-nav__icon md-icon"></span>
          Supported Model Frameworks/Formats
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../serving_runtime/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tensorflow/">
        Tensorflow
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../torchserve/">
        PyTorch
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../sklearn/v2/">
        Scikit-learn
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../xgboost/">
        XGBoost
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pmml/">
        PMML
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../spark/">
        Spark MLlib
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../lightgbm/">
        LightGBM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../paddle/">
        Paddle
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mlflow/v2/">
        MLFlow
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../onnx/">
        ONNX
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" id="__nav_4_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2_2">
          Multi-Framework Serving Runtimes
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Multi-Framework Serving Runtimes" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_2_2">
<span class="md-nav__icon md-icon"></span>
          Multi-Framework Serving Runtimes
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2_1" id="__nav_4_2_2_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2_2_1">
          Nvidia Triton
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Nvidia Triton" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_4_2_2_1">
<span class="md-nav__icon md-icon"></span>
          Nvidia Triton
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../triton/torchscript/">
        Torchscript
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../triton/bert/">
        Tensorflow
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../triton/huggingface/">
        Hugging Face
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../amd/">
        AMD
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_3" id="__nav_4_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2_3">
          LLM Runtime
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="LLM Runtime" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_2_3">
<span class="md-nav__icon md-icon"></span>
          LLM Runtime
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../llm/huggingface/">
        Hugging Face LLM
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../llm/torchserve/accelerate/">
        TorchServe LLM
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          How to write a custom predictor
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        How to write a custom predictor
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#setup">
    Setup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#create-and-deploy-custom-rest-servingruntime">
    Create and Deploy Custom REST ServingRuntime
  </a>
<nav aria-label="Create and Deploy Custom REST ServingRuntime" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implement-custom-model-using-kserve-api">
    Implement Custom Model using KServe API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#build-custom-serving-image-with-buildpacks">
    Build Custom Serving Image with BuildPacks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-locally-and-test">
    Deploy Locally and Test
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-the-rest-custom-serving-runtime-on-kserve">
    Deploy the REST Custom Serving Runtime on KServe
  </a>
<nav aria-label="Deploy the REST Custom Serving Runtime on KServe" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#arguments">
    Arguments
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#environment-variables">
    Environment Variables
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-a-prediction">
    Run a Prediction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#delete-the-inferenceservice">
    Delete the InferenceService
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#create-and-deploy-custom-grpc-servingruntime">
    Create and Deploy Custom gRPC ServingRuntime
  </a>
<nav aria-label="Create and Deploy Custom gRPC ServingRuntime" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implement-custom-model-using-kserve-api_1">
    Implement Custom Model using KServe API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#build-custom-serving-image-with-buildpacks_1">
    Build Custom Serving Image with BuildPacks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-locally-and-test_1">
    Deploy Locally and Test
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-the-grpc-custom-serving-runtime-on-kserve">
    Deploy the gRPC Custom Serving Runtime on KServe
  </a>
<nav aria-label="Deploy the gRPC Custom Serving Runtime on KServe" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#arguments_1">
    Arguments
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-a-grpc-prediction">
    Run a gRPC Prediction
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#parallel-model-inference">
    Parallel Model Inference
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3">
          Multi Model Serving
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Multi Model Serving" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
          Multi Model Serving
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_1" id="__nav_4_3_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3_1">
          Overview
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Overview" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_3_1">
<span class="md-nav__icon md-icon"></span>
          Overview
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mms/multi-model-serving/">
        The Scalability Problem
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mms/modelmesh/overview/">
        ModelMesh Overview
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" id="__nav_4_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_4">
          Transformers
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Transformers" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_4">
<span class="md-nav__icon md-icon"></span>
          Transformers
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../transformer/feast/">
        Feast
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../transformer/torchserve_image_transformer/">
        How to write a custom transformer
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../transformer/collocation/">
        Collocate transformer and predictor
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" id="__nav_4_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_5">
          Inference Graph
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Inference Graph" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_5">
<span class="md-nav__icon md-icon"></span>
          Inference Graph
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../inference_graph/">
        Concept
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../inference_graph/image_pipeline/">
        Image classification inference graph
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_6" id="__nav_4_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6">
          Model Storage
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Model Storage" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_6">
<span class="md-nav__icon md-icon"></span>
          Model Storage
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/storagecontainers/">
        Storage Containers
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/azure/azure/">
        Azure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/pvc/pvc/">
        PVC
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/s3/s3/">
        S3
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/oci/">
        OCI
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/uri/uri/">
        URI
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../certificate/kserve/">
        CA Certificate
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../storage/gcs/gcs/">
        GCS
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_7" id="__nav_4_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_7">
          Model Explainability
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Model Explainability" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_7">
<span class="md-nav__icon md-icon"></span>
          Model Explainability
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../explainer/explainer/">
        Concept
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_7_2" id="__nav_4_7_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_7_2">
          Alibi Explainer
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Alibi Explainer" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_7_2">
<span class="md-nav__icon md-icon"></span>
          Alibi Explainer
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../explainer/alibi/cifar10/">
        Image Explainer
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../explainer/alibi/income/">
        Income Explainer
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../explainer/alibi/moviesentiment/">
        Text Explainer
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../explainer/aix/mnist/aix/">
        AIX Explainer
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_8" id="__nav_4_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_8">
          Model Monitoring
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Model Monitoring" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_8">
<span class="md-nav__icon md-icon"></span>
          Model Monitoring
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../detect/alibi_detect/alibi_detect/">
        Alibi Detector
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../detect/aif/germancredit/">
        AIF Bias Detector
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../detect/art/mnist/">
        ART Adversarial Detector
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_9" id="__nav_4_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_9">
          Request Batching
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Request Batching" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_9">
<span class="md-nav__icon md-icon"></span>
          Request Batching
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../batcher/batcher/">
        Inference Batcher
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_10" id="__nav_4_10" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_10">
          Payload Logging
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Payload Logging" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_10">
<span class="md-nav__icon md-icon"></span>
          Payload Logging
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../logger/logger/">
        Inference Logger
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_11" id="__nav_4_11" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_11">
          Autoscaling
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Autoscaling" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_11">
<span class="md-nav__icon md-icon"></span>
          Autoscaling
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../autoscaling/autoscaling/">
        Inference Autoscaling
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_12" id="__nav_4_12" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_12">
          Node Scheduling
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Node Scheduling" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_12">
<span class="md-nav__icon md-icon"></span>
          Node Scheduling
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../nodescheduling/overview/">
        Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../nodescheduling/inferenceservicenodescheduling/">
        InferenceService Node Scheduling
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_13" id="__nav_4_13" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_13">
          Kafka
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Kafka" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_13">
<span class="md-nav__icon md-icon"></span>
          Kafka
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../kafka/kafka/">
        Inference with Kafka event source
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_14" id="__nav_4_14" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_14">
          Rollout Strategies
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Rollout Strategies" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_14">
<span class="md-nav__icon md-icon"></span>
          Rollout Strategies
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../rollout/canary/">
        Canary
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../rollout/canary-example/">
        Canary Example
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_15" id="__nav_4_15" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_15">
          Inference Observability
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Inference Observability" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_15">
<span class="md-nav__icon md-icon"></span>
          Inference Observability
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../observability/prometheus_metrics/">
        Prometheus Metrics
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../observability/grafana_dashboards/">
        Grafana Dashboards
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5">
          API Reference
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="API Reference" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../reference/api/">
        Control Plane API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../reference/swagger-ui/">
        Open Inference Protocol API Spec
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../sdk_docs/sdk_doc/">
        Python Client SDK
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../python_runtime_api/docs/">
        Python Runtime Server SDK
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6">
          Developer Guide
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Developer Guide" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../developer/developer/">
        How to contribute
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../developer/debug/">
        Debugging guide
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7">
          Blog
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Blog" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
          Blog
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_1" id="__nav_7_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_7_1">
          Releases
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Releases" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_7_1">
<span class="md-nav__icon md-icon"></span>
          Releases
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2023-10-08-KServe-0.13-release.md">
        KServe 0.13 Release
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2023-10-08-KServe-0.11-release/">
        KServe 0.11 Release
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2023-02-05-KServe-0.10-release/">
        KServe 0.10 Release
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2022-07-21-KServe-0.9-release/">
        KServe 0.9 Release
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2022-02-18-KServe-0.8-release/">
        KServe 0.8 Release
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2021-10-11-KServe-0.7-release/">
        KServe 0.7 Release
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_2" id="__nav_7_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_7_2">
          Articles
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Articles" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_7_2">
<span class="md-nav__icon md-icon"></span>
          Articles
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../blog/articles/2021-09-27-kfserving-transition/">
        KFserving Transition
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8">
          Community
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Community" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
          Community
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../community/adopters/">
        Adopters
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../../community/presentations/">
        Demos and Presentations
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#setup">
    Setup
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#create-and-deploy-custom-rest-servingruntime">
    Create and Deploy Custom REST ServingRuntime
  </a>
<nav aria-label="Create and Deploy Custom REST ServingRuntime" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implement-custom-model-using-kserve-api">
    Implement Custom Model using KServe API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#build-custom-serving-image-with-buildpacks">
    Build Custom Serving Image with BuildPacks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-locally-and-test">
    Deploy Locally and Test
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-the-rest-custom-serving-runtime-on-kserve">
    Deploy the REST Custom Serving Runtime on KServe
  </a>
<nav aria-label="Deploy the REST Custom Serving Runtime on KServe" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#arguments">
    Arguments
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#environment-variables">
    Environment Variables
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-a-prediction">
    Run a Prediction
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#delete-the-inferenceservice">
    Delete the InferenceService
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#create-and-deploy-custom-grpc-servingruntime">
    Create and Deploy Custom gRPC ServingRuntime
  </a>
<nav aria-label="Create and Deploy Custom gRPC ServingRuntime" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implement-custom-model-using-kserve-api_1">
    Implement Custom Model using KServe API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#build-custom-serving-image-with-buildpacks_1">
    Build Custom Serving Image with BuildPacks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-locally-and-test_1">
    Deploy Locally and Test
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deploy-the-grpc-custom-serving-runtime-on-kserve">
    Deploy the gRPC Custom Serving Runtime on KServe
  </a>
<nav aria-label="Deploy the gRPC Custom Serving Runtime on KServe" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#arguments_1">
    Arguments
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-a-grpc-prediction">
    Run a gRPC Prediction
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#parallel-model-inference">
    Parallel Model Inference
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/kserve/website/edit/main/docs/modelserving/v1beta1/custom/custom_model/README.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="deploy-custom-python-serving-runtime-with-inferenceservice">Deploy Custom Python Serving Runtime with InferenceService<a class="headerlink" href="#deploy-custom-python-serving-runtime-with-inferenceservice" title="Permanent link">¶</a></h1>
<p>When the out-of-the-box <code>Serving Runtime</code> does not fit your need, you can choose to build your own model server using <code>KServe ModelServer API</code>
to deploy as <code>Custom Serving Runtime</code> on KServe.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">¶</a></h2>
<ol>
<li>Install <a href="https://buildpacks.io/docs/tools/pack/">pack CLI</a> to build your custom model server image.</li>
</ol>
<h2 id="create-and-deploy-custom-rest-servingruntime">Create and Deploy Custom REST ServingRuntime<a class="headerlink" href="#create-and-deploy-custom-rest-servingruntime" title="Permanent link">¶</a></h2>
<h3 id="implement-custom-model-using-kserve-api">Implement Custom Model using KServe API<a class="headerlink" href="#implement-custom-model-using-kserve-api" title="Permanent link">¶</a></h3>
<p><code>KServe.Model</code> base class mainly defines three handlers <code>preprocess</code>, <code>predict</code> and <code>postprocess</code>, these handlers are executed
in sequence, the output of the <code>preprocess</code> is passed to <code>predict</code> as the input, the <code>predictor</code> handler executes the
inference for your model, the <code>postprocess</code> handler then turns the raw prediction result into user-friendly inference response. There
is an additional <code>load</code> handler which is used for writing custom code to load your model into the memory from local file system or
remote model storage, a general good practice is to call the <code>load</code> handler in the model server class <code>__init__</code> function, so your model
is loaded on startup and ready to serve prediction requests.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">kserve</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ModelServer</span>

<span class="k">class</span> <span class="nc">AlexNetModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
       <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">img_data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">"instances"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"b64"</span><span class="p">]</span>
        <span class="n">raw_img_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
        <span class="n">input_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">raw_img_data</span><span class="p">))</span>
        <span class="n">preprocess</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
                                 <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
        <span class="p">])</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">top_5</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">response_id</span> <span class="o">=</span> <span class="n">generate_uuid</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"predictions"</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AlexNetModel</span><span class="p">(</span><span class="s2">"custom-model"</span><span class="p">)</span>
    <span class="n">ModelServer</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">([</span><span class="n">model</span><span class="p">])</span>
</code></pre></div>
<h3 id="build-custom-serving-image-with-buildpacks">Build Custom Serving Image with BuildPacks<a class="headerlink" href="#build-custom-serving-image-with-buildpacks" title="Permanent link">¶</a></h3>
<p><a href="https://buildpacks.io/">Buildpacks</a> allows you to transform your inference code into images that can be deployed on KServe without
needing to define the <code>Dockerfile</code>. Buildpacks automatically determines the python application and then install the dependencies from the
<code>requirements.txt</code> file, it looks at the <code>Procfile</code> to determine how to start the model server. Here we are showing how to build the serving
image manually with <code>pack</code>, you can also choose to use <a href="https://github.com/pivotal/kpack">kpack</a>
to run the image build on the cloud and continuously build/deploy new versions from your source git repository.</p>
<p>You can use pack cli to build and push the custom model server image
<div class="highlight"><pre><span></span><code>pack<span class="w"> </span>build<span class="w"> </span>--builder<span class="o">=</span>heroku/buildpacks:20<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_USER</span><span class="si">}</span>/custom-model:v1
docker<span class="w"> </span>push<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_USER</span><span class="si">}</span>/custom-model:v1
</code></pre></div></p>
<p>Note: If your buildpack command fails, make sure you have a <code>runtimes.txt</code> file with the correct python version specified. See the <a href="https://github.com/kserve/kserve/blob/master/python/custom_model/runtime.txt">custom model server runtime.txt</a> file as an example.</p>
<h3 id="deploy-locally-and-test">Deploy Locally and Test<a class="headerlink" href="#deploy-locally-and-test" title="Permanent link">¶</a></h3>
<p>Launch the docker image built from last step with <code>buildpack</code>.
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-ePORT<span class="o">=</span><span class="m">8080</span><span class="w"> </span>-p8080:8080<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_USER</span><span class="si">}</span>/custom-model:v1
</code></pre></div></p>
<p>Send a test inference request locally with <a href="input.json">input.json</a>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span>localhost:8080/v1/models/custom-model:predict<span class="w"> </span>-d<span class="w"> </span>@./input.json
</code></pre></div></p>
<div class="admonition success">
<p class="admonition-title">Expected Output</p>
<div class="no-copy highlight"><pre><span></span><code><span class="p">{</span><span class="nt">"predictions"</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="mf">14.861763000488281</span><span class="p">,</span><span class="w"> </span><span class="mf">13.94291877746582</span><span class="p">,</span><span class="w"> </span><span class="mf">13.924378395080566</span><span class="p">,</span><span class="w"> </span><span class="mf">12.182709693908691</span><span class="p">,</span><span class="w"> </span><span class="mf">12.00634765625</span><span class="p">]]}</span>
</code></pre></div>
</div>
<h3 id="deploy-the-rest-custom-serving-runtime-on-kserve">Deploy the REST Custom Serving Runtime on KServe<a class="headerlink" href="#deploy-the-rest-custom-serving-runtime-on-kserve" title="Permanent link">¶</a></h3>
<p><div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serving.kserve.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InferenceService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">custom-model</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">predictor</span><span class="p">:</span>
<span class="w">    </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kserve-container</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${DOCKER_USER}/custom-model:v1</span>
</code></pre></div>
In the <code>custom.yaml</code> file edit the container image and replace ${DOCKER_USER} with your Docker Hub username.</p>
<h4 id="arguments">Arguments<a class="headerlink" href="#arguments" title="Permanent link">¶</a></h4>
<p>You can supply additional command arguments on the container spec to configure the model server.</p>
<ul>
<li><code>--workers</code>: Spawn the specified number of <code>uvicorn</code> workers(multi-processing) of the model server, the default value is 1, this option is often used
  to help increase the resource utilization of the container.</li>
<li><code>--http_port</code>: The http port model server is listening on, the default REST port is 8080.</li>
<li><code>--model_name</code>: The model name deployed in the model server, the default name the same as the service name.</li>
<li><code>--max_asyncio_workers</code>: Max number of workers to spawn for python async io loop, by default it is <code>min(32,cpu.limit + 4)</code>.</li>
<li><code>--enable_latency_logging</code>: Whether to log latency metrics per request, the default is True.</li>
<li><code>--configure_logging</code>: Whether to configure KServe and Uvicorn logging, the default is True.
In this case you may want to set the KServe <code>ModelServer</code>'s <code>log_config</code> parameter to pass a dictionary containing all the logging directives and configurations (see <a href="https://docs.python.org/3/library/logging.config.html#dictionary-schema-details">the Python upstream docs</a> for more info). The alternative is to use the <code>--log_config_file</code> argument described below.</li>
<li><code>--log_config_file</code>: The path of the Python config file configuration to use (either a json or a yaml file). This file allows to override the default Uvicorn configuration shipped with KServe. The default is None.</li>
<li><code>--access_log_format</code>: A string representing the access log format configuration to use. The functionality is provided by the <code>asgi-logger</code> library and it allows to override only the <code>uvicorn.access</code>'s format configuration with a richer set of fields (output hardcoded to <code>stdout</code>). This limitation is currently due to the ASGI specs that don't describe how access logging should be implemented in detail (please refer to this Uvicorn <a href="https://github.com/encode/uvicorn/issues/527">github issue</a> for more info). By default is None.</li>
</ul>
<h4 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">¶</a></h4>
<p>You can supply additional environment variables on the container spec.</p>
<ul>
<li><code>STORAGE_URI</code>: load a model from a storage system supported by KServe e.g. <code>pvc://</code> <code>s3://</code>. This acts the same as <code>storageUri</code> when using a built-in predictor.
  The data will be available at <code>/mnt/models</code> in the container. For example, the following <code>STORAGE_URI: "pvc://my_model/model.onnx"</code> will be accessible at <code>/mnt/models/model.onnx</code></li>
<li><code>PROTOCOL</code>: specify the protocol version supported by the model e.g <code>V1</code>. This acts the same as <code>protocolVersion</code> when using a built-in predictor.</li>
<li><code>KSERVE_LOGLEVEL</code>: sets the <code>kserve</code> and <code>kserve_trace</code>'s logger verbosity. Default is <code>INFO</code>.</li>
</ul>
<p>Apply the yaml to deploy the InferenceService on KServe</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">kubectl</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</input></div>
<div class="highlight"><pre><span></span><code>kubectl apply -f custom.yaml
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Expected Output</p>
<div class="no-copy highlight"><pre><span></span><code>$<span class="w"> </span>inferenceservice.serving.kserve.io/custom-model<span class="w"> </span>created
</code></pre></div>
</div>
<h3 id="run-a-prediction">Run a Prediction<a class="headerlink" href="#run-a-prediction" title="Permanent link">¶</a></h3>
<p>The first step is to <a href="../../../../get_started/first_isvc/#4-determine-the-ingress-ip-and-ports">determine the ingress IP and ports</a> and set <code>INGRESS_HOST</code> and <code>INGRESS_PORT</code></p>
<div class="highlight"><pre><span></span><code><span class="nv">MODEL_NAME</span><span class="o">=</span>custom-model
<span class="nv">INPUT_PATH</span><span class="o">=</span>@./input.json
<span class="nv">SERVICE_HOSTNAME</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>inferenceservice<span class="w"> </span><span class="si">${</span><span class="nv">MODEL_NAME</span><span class="si">}</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.url}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s2">"/"</span><span class="w"> </span>-f<span class="w"> </span><span class="m">3</span><span class="k">)</span>

curl<span class="w"> </span>-v<span class="w"> </span>-H<span class="w"> </span><span class="s2">"Host: </span><span class="si">${</span><span class="nv">SERVICE_HOSTNAME</span><span class="si">}</span><span class="s2">"</span><span class="w"> </span>-H<span class="w"> </span><span class="s2">"Content-Type: application/json"</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">INGRESS_HOST</span><span class="si">}</span>:<span class="si">${</span><span class="nv">INGRESS_PORT</span><span class="si">}</span>/v1/models/<span class="si">${</span><span class="nv">MODEL_NAME</span><span class="si">}</span>:predict<span class="w"> </span>-d<span class="w"> </span><span class="nv">$INPUT_PATH</span>
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Expected Output</p>
<div class="no-copy highlight"><pre><span></span><code>*<span class="w">   </span>Trying<span class="w"> </span><span class="m">169</span>.47.250.204...
*<span class="w"> </span>TCP_NODELAY<span class="w"> </span><span class="nb">set</span>
*<span class="w"> </span>Connected<span class="w"> </span>to<span class="w"> </span><span class="m">169</span>.47.250.204<span class="w"> </span><span class="o">(</span><span class="m">169</span>.47.250.204<span class="o">)</span><span class="w"> </span>port<span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">(</span><span class="c1">#0)</span>
&gt;<span class="w"> </span>POST<span class="w"> </span>/v1/models/custom-model:predict<span class="w"> </span>HTTP/1.1
&gt;<span class="w"> </span>Host:<span class="w"> </span>custom-model.default.example.com
&gt;<span class="w"> </span>User-Agent:<span class="w"> </span>curl/7.64.1
&gt;<span class="w"> </span>Accept:<span class="w"> </span>*/*
&gt;<span class="w"> </span>Content-Length:<span class="w"> </span><span class="m">105339</span>
&gt;<span class="w"> </span>Content-Type:<span class="w"> </span>application/x-www-form-urlencoded
&gt;<span class="w"> </span>Expect:<span class="w"> </span><span class="m">100</span>-continue
&gt;
&lt;<span class="w"> </span>HTTP/1.1<span class="w"> </span><span class="m">100</span><span class="w"> </span>Continue
*<span class="w"> </span>We<span class="w"> </span>are<span class="w"> </span>completely<span class="w"> </span>uploaded<span class="w"> </span>and<span class="w"> </span>fine
&lt;<span class="w"> </span>HTTP/1.1<span class="w"> </span><span class="m">200</span><span class="w"> </span>OK
&lt;<span class="w"> </span>content-length:<span class="w"> </span><span class="m">232</span>
&lt;<span class="w"> </span>content-type:<span class="w"> </span>text/html<span class="p">;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>UTF-8
&lt;<span class="w"> </span>date:<span class="w"> </span>Wed,<span class="w"> </span><span class="m">26</span><span class="w"> </span>Feb<span class="w"> </span><span class="m">2020</span><span class="w"> </span><span class="m">15</span>:19:15<span class="w"> </span>GMT
&lt;<span class="w"> </span>server:<span class="w"> </span>istio-envoy
&lt;<span class="w"> </span>x-envoy-upstream-service-time:<span class="w"> </span><span class="m">213</span>
&lt;
*<span class="w"> </span>Connection<span class="w"> </span><span class="c1">#0 to host 169.47.250.204 left intact</span>
<span class="o">{</span><span class="s2">"predictions"</span>:<span class="w"> </span><span class="o">[[</span><span class="m">14</span>.861762046813965,<span class="w"> </span><span class="m">13</span>.942917823791504,<span class="w"> </span><span class="m">13</span>.9243803024292,<span class="w"> </span><span class="m">12</span>.182711601257324,<span class="w"> </span><span class="m">12</span>.00634765625<span class="o">]]}</span>
</code></pre></div>
</div>
<h3 id="delete-the-inferenceservice">Delete the InferenceService<a class="headerlink" href="#delete-the-inferenceservice" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>custom.yaml
</code></pre></div>
<h2 id="create-and-deploy-custom-grpc-servingruntime">Create and Deploy Custom gRPC ServingRuntime<a class="headerlink" href="#create-and-deploy-custom-grpc-servingruntime" title="Permanent link">¶</a></h2>
<p>KServe gRPC ServingRuntimes enables high performance inference data plane which implements the <code>Open(v2) Inference Protocol</code>:</p>
<ul>
<li>gRPC is built on top of HTTP/2 for addressing the
  shortcomings of <a href="https://en.wikipedia.org/wiki/Head-of-line_blocking">head-of-line-blocking</a> and <a href="https://en.wikipedia.org/wiki/HTTP_pipelining">pipelining</a>,</li>
<li>gRPC transports binary data format with <a href="https://github.com/protocolbuffers/protobuf">Protobuf</a> which is efficient to send over the wire.</li>
</ul>
<p>Compared to REST it has limited support for browser and the message is not human-readable which requires additional debugging tools.</p>
<h3 id="implement-custom-model-using-kserve-api_1">Implement Custom Model using KServe API<a class="headerlink" href="#implement-custom-model-using-kserve-api_1" title="Permanent link">¶</a></h3>
<p>For <code>Open(v2) Inference Protocol</code>, KServe provides <code>InferRequest</code> and <code>InferResponse</code> API object for <code>predict</code>, <code>preprocess</code>, <code>postprocess</code>
handlers to abstract away the implementation details of REST/gRPC decoding and encoding over the wire.</p>
<div class="highlight"><span class="filename">model_grpc.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">kserve</span> <span class="kn">import</span> <span class="n">InferRequest</span><span class="p">,</span> <span class="n">InferResponse</span><span class="p">,</span> <span class="n">InferOutput</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ModelServer</span>
<span class="kn">from</span> <span class="nn">kserve.utils.utils</span> <span class="kn">import</span> <span class="n">generate_uuid</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">transforms</span>


<span class="c1"># This custom predictor example implements the custom model following KServe v2 inference gPPC protocol,</span>
<span class="c1"># the input can be raw image bytes or image tensor which is pre-processed by transformer</span>
<span class="c1"># and then passed to predictor, the output is the prediction response.</span>
<span class="k">class</span> <span class="nc">AlexNetModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">InferRequest</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InferResponse</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">input_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">preprocess</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
                                     <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
            <span class="p">])</span>

        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">input_image</span><span class="p">)</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">input_tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">top_5</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">response_id</span> <span class="o">=</span> <span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">infer_output</span> <span class="o">=</span> <span class="n">InferOutput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"output-0"</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="s2">"FP32"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="n">infer_response</span> <span class="o">=</span> <span class="n">InferResponse</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">infer_outputs</span><span class="o">=</span><span class="p">[</span><span class="n">infer_output</span><span class="p">],</span> <span class="n">response_id</span><span class="o">=</span><span class="n">response_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">infer_response</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AlexNetModel</span><span class="p">(</span><span class="s2">"custom-model"</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">ModelServer</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">([</span><span class="n">model</span><span class="p">])</span>
</code></pre></div>
<h3 id="build-custom-serving-image-with-buildpacks_1">Build Custom Serving Image with BuildPacks<a class="headerlink" href="#build-custom-serving-image-with-buildpacks_1" title="Permanent link">¶</a></h3>
<p>Similar to building the REST custom image, you can also use pack cli to build and push the custom gRPC model server image
<div class="highlight"><pre><span></span><code>pack<span class="w"> </span>build<span class="w"> </span>--builder<span class="o">=</span>heroku/buildpacks:20<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_USER</span><span class="si">}</span>/custom-model-grpc:v1
docker<span class="w"> </span>push<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_USER</span><span class="si">}</span>/custom-model-grpc:v1
</code></pre></div></p>
<p>Note: If your buildpack command fails, make sure you have a <code>runtimes.txt</code> file with the correct python version specified. See the <a href="https://github.com/kserve/kserve/blob/master/python/custom_model/runtime.txt">custom model server runtime.txt</a> file as an example.</p>
<h3 id="deploy-locally-and-test_1">Deploy Locally and Test<a class="headerlink" href="#deploy-locally-and-test_1" title="Permanent link">¶</a></h3>
<p>Launch the docker image built from last step with <code>buildpack</code>.
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-ePORT<span class="o">=</span><span class="m">8081</span><span class="w"> </span>-p8081:8081<span class="w"> </span><span class="si">${</span><span class="nv">DOCKER_USER</span><span class="si">}</span>/custom-model-grpc:v1
</code></pre></div></p>
<p>Send a test inference request locally using <code>InferenceServerClient</code> <a href="grpc_test_client.py">grpc_test_client.py</a>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">kserve</span> <span class="kn">import</span> <span class="n">InferRequest</span><span class="p">,</span> <span class="n">InferInput</span><span class="p">,</span> <span class="n">InferenceServerClient</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">InferenceServerClient</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"INGRESS_HOST"</span><span class="p">,</span> <span class="s2">"localhost"</span><span class="p">)</span><span class="o">+</span><span class="s2">":"</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"INGRESS_PORT"</span><span class="p">,</span> <span class="s2">"8081"</span><span class="p">),</span>
                               <span class="n">channel_args</span><span class="o">=</span><span class="p">((</span><span class="s1">'grpc.ssl_target_name_override'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"SERVICE_HOSTNAME"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)),))</span>
<span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"./input.json"</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
<span class="n">infer_input</span> <span class="o">=</span> <span class="n">InferInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"input-0"</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">datatype</span><span class="o">=</span><span class="s2">"BYTES"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"instances"</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">"image"</span><span class="p">][</span><span class="s2">"b64"</span><span class="p">])])</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">InferRequest</span><span class="p">(</span><span class="n">infer_inputs</span><span class="o">=</span><span class="p">[</span><span class="n">infer_input</span><span class="p">],</span> <span class="n">model_name</span><span class="o">=</span><span class="s2">"custom-model"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">infer_request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>grpc_test_client.py
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Expected Output</p>
<div class="no-copy highlight"><pre><span></span><code><span class="err">id</span><span class="p">:</span><span class="w"> </span><span class="s2">"df27b8a5-f13e-4c7a-af61-20bdb55b6523"</span>
<span class="err">ou</span><span class="kc">t</span><span class="err">pu</span><span class="kc">ts</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">"output-0"</span>
<span class="w">  </span><span class="err">da</span><span class="kc">tat</span><span class="err">ype</span><span class="p">:</span><span class="w"> </span><span class="s2">"FP32"</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="err">co</span><span class="kc">ntents</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.9756203</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.036808</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">13.9660349</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.2522783</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.0862684</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">model_</span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">"custom-model"</span>
<span class="err">id</span><span class="p">:</span><span class="w"> </span><span class="s2">"df27b8a5-f13e-4c7a-af61-20bdb55b6523"</span>
<span class="err">ou</span><span class="kc">t</span><span class="err">pu</span><span class="kc">ts</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">"output-0"</span>
<span class="w">  </span><span class="err">da</span><span class="kc">tat</span><span class="err">ype</span><span class="p">:</span><span class="w"> </span><span class="s2">"FP32"</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="err">co</span><span class="kc">ntents</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.9756203</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.036808</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">13.9660349</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.2522783</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.0862684</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<h3 id="deploy-the-grpc-custom-serving-runtime-on-kserve">Deploy the gRPC Custom Serving Runtime on KServe<a class="headerlink" href="#deploy-the-grpc-custom-serving-runtime-on-kserve" title="Permanent link">¶</a></h3>
<p>Create the InferenceService yaml and expose the gRPC port by specifying on <code>ports</code> section, currently only one port is allowed to expose and by default HTTP port is exposed.
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">serving.kserve.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">InferenceService</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">custom-model-grpc</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">predictor</span><span class="p">:</span>
<span class="w">    </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kserve-container</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${DOCKER_USER}/custom-model-grpc:v1</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">h2c</span>
<span class="w">            </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8081</span>
<span class="w">            </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
</code></pre></div>
In the <code>custom_grpc.yaml</code> file edit the container image and replace ${DOCKER_USER} with your Docker Hub username.</p>
<h4 id="arguments_1">Arguments<a class="headerlink" href="#arguments_1" title="Permanent link">¶</a></h4>
<p>You can supply additional command arguments on the container spec to configure the model server.</p>
<ul>
<li><code>--grpc_port</code>: the http port model server is listening on, the default gRPC port is 8081.</li>
<li><code>--model_name</code>: the model name deployed in the model server, the default name the same as the service name.</li>
<li><code>enable_latency_logging</code>: whether to log latency metrics per request, the default is True.</li>
</ul>
<p>Apply the yaml to deploy the InferenceService on KServe</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio"><div class="tabbed-labels"><label for="__tabbed_2_1">kubectl</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</input></div>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>custom_grpc.yaml
</code></pre></div>
<div class="admonition successs">
<p class="admonition-title">Expected Output</p>
<div class="no-copy highlight"><pre><span></span><code>$<span class="w"> </span>inferenceservice.serving.kserve.io/custom-model-grpc<span class="w"> </span>created
</code></pre></div>
</div>
<h3 id="run-a-grpc-prediction">Run a gRPC Prediction<a class="headerlink" href="#run-a-grpc-prediction" title="Permanent link">¶</a></h3>
<p>The first step is to <a href="../../../../get_started/first_isvc/#4-determine-the-ingress-ip-and-ports">determine the ingress IP and ports</a> and set <code>INGRESS_HOST</code> and <code>INGRESS_PORT</code></p>
<div class="highlight"><pre><span></span><code><span class="nv">MODEL_NAME</span><span class="o">=</span>custom-model
<span class="nv">SERVICE_HOSTNAME</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>inferenceservice<span class="w"> </span>custom-model-grpc<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.url}'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s2">"/"</span><span class="w"> </span>-f<span class="w"> </span><span class="m">3</span><span class="k">)</span>
</code></pre></div>
<p>Send an inference request to the gRPC service using <code>InferenceServerClient</code> <a href="grpc_test_client.py">grpc_test_client.py</a>.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>grpc_test_client.py
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Expected Output</p>
<div class="no-copy highlight"><pre><span></span><code><span class="err">id</span><span class="p">:</span><span class="w"> </span><span class="s2">"df27b8a5-f13e-4c7a-af61-20bdb55b6523"</span>
<span class="err">ou</span><span class="kc">t</span><span class="err">pu</span><span class="kc">ts</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">"output-0"</span>
<span class="w">  </span><span class="err">da</span><span class="kc">tat</span><span class="err">ype</span><span class="p">:</span><span class="w"> </span><span class="s2">"FP32"</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="err">co</span><span class="kc">ntents</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.9756203</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.036808</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">13.9660349</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.2522783</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.0862684</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">model_</span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">"custom-model"</span>
<span class="err">id</span><span class="p">:</span><span class="w"> </span><span class="s2">"df27b8a5-f13e-4c7a-af61-20bdb55b6523"</span>
<span class="err">ou</span><span class="kc">t</span><span class="err">pu</span><span class="kc">ts</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">"output-0"</span>
<span class="w">  </span><span class="err">da</span><span class="kc">tat</span><span class="err">ype</span><span class="p">:</span><span class="w"> </span><span class="s2">"FP32"</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="err">shape</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span>
<span class="w">  </span><span class="err">co</span><span class="kc">ntents</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.9756203</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">14.036808</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">13.9660349</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.2522783</span>
<span class="w">    </span><span class="kc">f</span><span class="err">p</span><span class="mi">32</span><span class="err">_co</span><span class="kc">ntents</span><span class="p">:</span><span class="w"> </span><span class="mf">12.0862684</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<h2 id="parallel-model-inference">Parallel Model Inference<a class="headerlink" href="#parallel-model-inference" title="Permanent link">¶</a></h2>
<p>By default, the models are loaded in the same process and inference is executed in the same process as the HTTP or gRPC server, if you are hosting multiple models
the inference can only be run for one model at a time which limits the concurrency when you share the container for the models.
KServe integrates <a href="https://docs.ray.io/en/master/serve/index.html">RayServe</a> which provides a programmable API to deploy models
as separate python workers so the inference can be performed in parallel when serving multiple custom models.</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">kserve</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"custom-model"</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AlexNetModel</span><span class="p">(</span><span class="n">kserve</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"custom-model"</span>
       <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">kserve</span><span class="o">.</span><span class="n">ModelServer</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">({</span><span class="s2">"custom-model"</span><span class="p">:</span> <span class="n">AlexNetModel</span><span class="p">})</span>
</code></pre></div>
fractional gpu example
<div class="highlight"><pre><span></span><code><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"custom-model"</span><span class="p">,</span> <span class="n">num_replicas</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ray_actor_options</span><span class="o">=</span><span class="p">{</span><span class="s2">"num_cpus"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"num_gpus"</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
<span class="k">class</span> <span class="nc">AlexNetModel</span><span class="p">(</span><span class="n">kserve</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"custom-model"</span>
       <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kserve</span><span class="o">.</span><span class="n">ModelServer</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">({</span><span class="s2">"custom-model"</span><span class="p">:</span> <span class="n">AlexNetModel</span><span class="p">})</span>
</code></pre></div>
The more details for ray fractional cpu and gpu can be found <a href="https://docs.ray.io/en/latest/serve/resource-allocation.html#fractional-cpus-and-fractional-gpus">here</a>.</p>
<p>The full code example can be found <a href="https://github.com/kserve/kserve/blob/release-0.11/python/custom_model/model_remote.py">here</a>.</p>
<p>Modify the <code>Procfile</code> to <code>web: python -m model_remote</code> and then run the above <code>pack</code> command, it builds the serving image which launches
each model as separate python worker and web server routes to the model workers by name.</p>
<p><img alt="parallel_inference" src="parallel_inference.png"/></p>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" data-md-state="hidden" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg>
            Back to top
          </a>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: TorchServe LLM" class="md-footer__link md-footer__link--prev" href="../../llm/torchserve/accelerate/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              TorchServe LLM
            </div>
</div>
</a>
<a aria-label="Next: The Scalability Problem" class="md-footer__link md-footer__link--next" href="../../../mms/multi-model-serving/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              The Scalability Problem
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2021 The KServe Authors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/kserve" rel="noopener" target="_blank" title="KServe Community on Github">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-social__link" href="https://github.com/kserve/community/blob/main/README.md#questions-and-issues" rel="noopener" target="_blank" title="Join Slack">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.tabs.sticky", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.cefbb252.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
<script src="../../../../assets/javascripts/bundle.a5f8ea78.min.js"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>